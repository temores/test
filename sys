# Solicitar la nueva configuración de red
$NewIPAddress = Read-Host "Ingrese la nueva dirección IP"
$SubnetMask = Read-Host "Ingrese la máscara de subred (ej. 24 para /24)"
$Gateway = Read-Host "Ingrese la puerta de enlace"
$PrimaryDNS = Read-Host "Ingrese el DNS Primario"

# Obtener el adaptador de red activo
$Adapter = Get-NetAdapter | Where-Object { $_.Status -eq "Up" }

if ($Adapter) {
    # Configurar la nueva dirección IP
    $InterfaceIndex = $Adapter.ifIndex
    New-NetIPAddress -InterfaceIndex $InterfaceIndex -IPAddress $NewIPAddress -PrefixLength $SubnetMask -DefaultGateway $Gateway -Confirm:$false

    # Configurar DNS Primario
    Set-DnsClientServerAddress -InterfaceIndex $InterfaceIndex -ServerAddresses $PrimaryDNS

    Write-Host "Dirección IP configurada: $NewIPAddress" -ForegroundColor Green
    Write-Host "DNS Primario configurado: $PrimaryDNS" -ForegroundColor Green
} else {
    Write-Host "No se encontró un adaptador de red activo." -ForegroundColor Red
    exit
}

# Solicitar el nuevo nombre del host
$NewHostname = Read-Host "Ingrese el nuevo nombre de host"

# Cambiar el nombre del host
Rename-Computer -NewName $NewHostname -Force
Write-Host "El nombre del servidor ha sido cambiado a $NewHostname" -ForegroundColor Green

# ==========================
# Descargar e instalar BgInfo
# ==========================
$BgInfoUrl = "https://download.sysinternals.com/files/BgInfo.zip"
$BgInfoZip = "$env:TEMP\BgInfo.zip"
$BgInfoPath = "C:\BgInfo"
$BgInfoExe = "$BgInfoPath\Bginfo64.exe"
$BgInfoConfig = "$BgInfoPath\custom.bgi"

# Crear la carpeta destino si no existe
if (!(Test-Path -Path $BgInfoPath)) {
    New-Item -ItemType Directory -Path $BgInfoPath | Out-Null
}

# Descargar BgInfo
Write-Host "Descargando BgInfo desde Sysinternals..."
Invoke-WebRequest -Uri $BgInfoUrl -OutFile $BgInfoZip

# Extraer BgInfo
Expand-Archive -Path $BgInfoZip -DestinationPath $BgInfoPath -Force
Write-Host "BgInfo descargado y extraído en $BgInfoPath" -ForegroundColor Green

# Crear un archivo de configuración vacío si no existe
if (!(Test-Path -Path $BgInfoConfig)) {
    New-Item -ItemType File -Path $BgInfoConfig | Out-Null
}

# ==========================
# Agregar BgInfo al inicio de sesión usando el Registro de Windows
# ==========================
$RegPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
$RegName = "BGInfo"
$RegValue = "`"$BgInfoExe`" `"$BgInfoConfig`" /silent /timer:0 /accepteula"

# Crear la clave de registro para ejecución en el inicio
Set-ItemProperty -Path $RegPath -Name $RegName -Value $RegValue
Write-Host "BgInfo configurado para ejecutarse en el inicio del sistema." -ForegroundColor Green

# ==========================
# Reiniciar el servidor
# ==========================
Write-Host "Reiniciando el servidor en 10 segundos..."
Start-Sleep -Seconds 10
Restart-Computer -Force
